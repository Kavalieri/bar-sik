name: ğŸš€ BAR-SIK Professional CI
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  lint-format:
    name: ğŸ¨ Lint & Format
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: ğŸ“¦ Install gdtoolkit
        run: pip install gdtoolkit

      - name: ğŸ¨ Check GDScript formatting
        run: |
          echo "ğŸ” Verificando formato de archivos GDScript..."
          gdformat --check $(git ls-files '*.gd') || {
            echo "âŒ Archivos mal formateados encontrados"
            echo "ğŸ’¡ Ejecuta: gdformat \$(git ls-files '*.gd')"
            exit 1
          }

      - name: ğŸ“ Lint GDScript
        run: |
          echo "ğŸ” Ejecutando anÃ¡lisis de estilo..."
          gdlint $(git ls-files '*.gd') || {
            echo "âŒ Errores de estilo encontrados"
            exit 1
          }

  tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ® Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: "4.3"

      - name: ğŸ§ª Run GUT Tests
        run: |
          echo "ğŸš€ Ejecutando tests en modo headless..."
          godot --headless --path . -s addons/gut/gut_cmdln.gd -gdir=res://tests -gexit || {
            echo "âŒ Tests fallaron"
            exit 1
          }

  code-quality:
    name: ğŸ“Š Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install jscpd
        run: npm i -g jscpd

      - name: ğŸ” Analyze GDScript Duplication
        run: |
          echo "ğŸ” Analizando duplicaciÃ³n en archivos GDScript..."
          jscpd --config .jscpd.gd.json

      - name: ğŸ­ Analyze Scene Duplication
        run: |
          echo "ğŸ” Analizando duplicaciÃ³n en escenas..."
          jscpd --config .jscpd.tscn.json

      - name: ğŸ“Š Upload Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: quality-reports
          path: reports/

      - name: ğŸ’¬ Quality Summary
        run: |
          echo "ğŸ“Š === RESUMEN DE CALIDAD ==="
          echo "âœ… AnÃ¡lisis completado"
          echo "ğŸ“„ Reportes disponibles en artifacts"

  security:
    name: ğŸ”’ Security Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”’ Security Scan
        run: |
          echo "ğŸ”’ Ejecutando anÃ¡lisis de seguridad bÃ¡sico..."

          # Verificar archivos sensibles
          if find . -name "*.key" -o -name "*.pem" -o -name "password*" | grep -v .git; then
            echo "âš ï¸ Archivos potencialmente sensibles encontrados"
          fi

          # Verificar credenciales hardcodeadas (bÃ¡sico)
          if grep -r "password\|secret\|key.*=" --include="*.gd" --include="*.cs" .; then
            echo "âš ï¸ Posibles credenciales hardcodeadas encontradas"
          fi

          echo "âœ… AnÃ¡lisis de seguridad completado"
